<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ちいかわ Image Gen</title>
    <link rel="stylesheet" href="css/mask.css">
    <link rel="stylesheet" href="css/story-protocol.css">
    <link rel="stylesheet" href="css/IPregister.css">
    <script src="https://unpkg.com/konva@8.0.2/konva.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <!-- url button to publish-->
    <a id="backButton" href="http://localhost:5000/publish">See NFT lists!</a>
    <!-- Container for the wallet login button in the right upper corner -->
    <div class="login-container">
        <button class="metamask-button" id="connectButton">
            <img src="image/metamask.png" alt="metamask logo" width="20px" style="margin-right: 5px;" /> Connect wallet
        </button>
        <div id="walletID">Your wallet is not connected yet.</div>
    </div>

    <div class="container" style="margin-top: 100px;">
        <h1>ちいかわ</h1>
    </div>

    <div class="container" style="margin-top: 20px;"> 
        <div id="imageContainer">
            <img src="image/chiikawa_rgba.png" id="sourceImage" alt="Image">
            <canvas id="canvasMask" width="248" height="248"></canvas>
        </div>
    </div>

    <div class="container" style="margin-top: 10px;">
        <button onclick="confirmMask()">Confirm Mask Selection</button>    
        <button id="reloadButton" style="margin-left: 10px;">Reload</button>  
    </div>

    <div class="container" style="text-align: center;">
        <h4>Left-click three times on the canvas and drag to start creating a mask.<br>Use mouse wheel to change the circle size.<br>Confirm the mask selection and type in prompt to generate a new image.<br>Enjoy creating pics!</h4>
    </div>

    <div class="container" style="margin-top: 30px;">
        <textarea id="textBox" placeholder="Enter text here..."></textarea>
    </div>

    <div class="container" style="margin-top: 10px;">
        <button id="generateButton">Generate</button>
    </div>

    <div class="container" style="margin-top: 20px;">
        <button id="mintButton" disabled>Mint your NFT :D</button> <!-- The mint button that shows up after generating an image -->
    </div>

    <script>
        let isGenerating = false;

        // Check if wallet is connected and show the mint button when a new image is generated
        async function checkWalletConnection() {
            if (typeof window.ethereum !== 'undefined') {
                const accounts = await ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    document.getElementById('walletID').textContent = `Connected: ${accounts[0]}`;
                    walletConnected = true;
                } else {
                    document.getElementById('walletID').textContent = 'Your wallet is not connected yet.';
                    walletConnected = false;
                }
            } else {
                document.getElementById('walletID').textContent = 'MetaMask is not installed.';
                walletConnected = false;
            }
        }

        // Connect wallet button
        document.getElementById('connectButton').addEventListener('click', async () => {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                    document.getElementById('walletID').textContent = `Connected: ${accounts[0]}`;
                    walletConnected = true;
                } catch (error) {
                    console.error('User rejected the request.');
                    walletConnected = false;
                }
            } else {
                document.getElementById('walletID').textContent = 'MetaMask is not installed.';
            }
        });
    </script>

    <!-- Canvas and Mask Creation Script -->
    <script src="js/mask.js"></script>
    <script src="js/metamask.js"></script>

    <script>
        // Asynchronously set session on page load
        window.addEventListener('load', async () => {
            try {
                const response = await fetch('/setSession', { method: 'POST' });
                if (response.ok) {
                    console.log('Session variable reset successfully.');
                } else {
                    console.error('Failed to reset session variable.');
                }
            } catch (error) {
                console.error('Error setting session variable:', error);
            }
        });
    </script>
</body>
</html>
